# API коллтрекинг (выгрузка звонков)  
## Содержание  
* [Получение информации по звонкам](#получение-информации-по-звонкам)  
  * [Пример запроса и описание параметров запроса](#пример-запроса-и-описание-параметров-запроса)  
    * [Описание параметров запроса](#описание-параметров-запроса)  
    * [Описание возможных параметров method](#описание-возможных-параметров-method)  
    * [Пример запроса](#пример-запроса)  
  * [Формат получаемого ответа, описание полей](#Формат-получаемого-ответа,-описание-полей)  
    * [Формат ответа](#формат-ответа) 
    * [Оисание полей](#оисание-полей) 
    * [Форматы ответов при неправильном или неуспешном запросе](#форматы-ответов-при-неправильном-или-неуспешном-запросе)    
    * [Описание возможных ошибок при запросах к API](#описание-возможных-ошибок-при-запросах-к-API)   
    
## Получение информации по звонкам  
Данный метод API позволяет получать полную информацию по звонкам как из сервиса CallTracking (то есть прямые звонки на подменные номера), так и из сервиса callback (то есть обратные звонки, заказанные с различных инструментов на сайте). Запрос осуществляется методом GET.  
### Пример запроса и описание параметров запроса  
В общем виде запрос на получение информации по звонкам выглядит следующим образом:  
https://ckct.ru/api/?{{format}}/{{version}}/{{apikey}}/{{entity}}/{{method}}/{{pages}}/{{from}}/{{to}}  
#### Описание параметров запроса  
***{{format}}*** - формат данных в котором вы хотите получить информацию по звонкам. На данный момент доступен только формат *json*.  
***{{version}}*** - версия API. Актуальная версия в настоящее время - это *v3*, в запросах следует указывать именно ее.  
***{{apikey}}*** - секретный ключ для доступа к API. Его можно получить у своего ведущего менеджера. Ключ представляет собой буквенно-числовую последовательность длинной 16 символов.  
***{{entity}}*** - сущность к которой предоставляет доступ API. В данном случае речь идет о получении звонков, соответственно сущность к которой нужен доступ - это звонок *call*.  
***{{method}}*** - параметр обозначает действие которое необходимо произвести *get*, *put*, *delete*. В данном случае для получения звонков необходим метод *get*.  
***{{pages}}*** - если у пользователя много звонков, то выводить в ответе сразу все было бы не эффективно, по этому вывод сделан по странично. В данном параметре вы можете указать номер конкретной страницы, которую хотите получить, это просто десятичное число. Нумерация страниц начинается с 0.  
***{{from}}*** - параметр устанавливает начальную дату выборки. Его можно передавать в двух форматах. В виде timestamp (количество секунд, прошедших с полуночи 1 января 1970 года) *1588854585*. Либо в следующем формате "yyy-mm-dd" *2020-05-07*  
***{{to}}*** - параметр устанавливает конечную дату выборки. Имеет тот же формат что и предыдущий параметр. Данный параметр не является обязательным, при его отсутствии конечная дата выборки будет равна текущей дате. 
#### Описание возможных параметров method
**call** - метод, с помощью которого можно получить все звонки принадлежащие непосредственно пользователю, не учитывая звонки к которым он имеет доступ с помощью выданной роли. В данном методе используется АПИ ключ пользователя (ключ либо выдается менеджером, либо его можно создать во вкладке - "Интеграции").  
**getByRole** - метод, с помощью которого можно получить звонки к которым пользователь имеет доступ по выданное роли, звонки принадлежащие непосредственно пользователю в данном параметре учитываться не будут. Следует учесть, что для использования данного метода необходимо использовать АПИ-ключ для выданной роли (на данный момент этот ключ необходимо запросить у менеджера), а не АПИ-ключ пользователя, как в других методах.  
**getWithRole** - метод, с помощью которого можно получить все звонки, как принадлежащие непосредственно пользователю, так и выданные ему по роли. В данном методе используется АПИ ключ пользователя (ключ либо выдается менеджером, либо его можно создать во вкладке - "Интеграции").  
#### Пример запроса  
https://ckct.ru/api/?json/v3/x9xx99xx99xxxx99/call/get/0/2020-05-01/2020-05-02  
Данный запрос демонстрирует запрос на получение звонков, принадлежащих пользователю без учета ролей, в формате JSON с 1 по 2 мая 2020.  
https://ckct.ru/api/?json/v3/x9xx99xx99xxxx99/call/getByRole/0/2020-05-01/2020-05-02  
Данный запрос демонстрирует запрос на получение звонков, выданных пользователю по роли, в формате JSON с 1 по 2 мая 2020.  
https://ckct.ru/api/?json/v3/x9xx99xx99xxxx99/call/getWithRole/0/2020-05-01/2020-05-02  
Данный запрос демонстрирует запрос на получение всех звонков, как выданных пользователю по роли, так и принадлежащих непосредственно пользователю, в формате JSON с 1 по 2 мая 2020.  
### Формат получаемого ответа, описание полей  
#### Формат ответа   
Представляет из себя массив звонков в формате JSON
```
[  
  {
    "page": 1,
    "universalId": "23423423434434234",
    "serviceType": "calltracking",
    "clientNumber": "7999999999",
    "managerNumber": "7888888888",
    "callerIdToManager": "79999999999",
    "callerIdToClient": "79999999999",
    "statusFirst": 200,
    "statusSecond": 200,
    "status": "success",
    "callTime": "2020-04-05 13:23:32",
    "localDate": "2020-04-05 15:23:32",
    "timezoneOffset": "+0020",
    "duration": 152,
    "tariffTime": 3,
    "site": "mysite.ru",
    "recordUrl": "https://callkeeper.ru/record",
    "unique": true,
    "target": true,
    "uniqueTarget":  false,
    "visitSite": "callkeeperr.ru",
    "referrer": "search.ru",
    "utm_source": "search",
    "utm_medium": "cpc",
    "utm_campaign": "advert",
    "utm_content": "goods",
    "utm_term": "some info",
    "yaClid": "534543523543",
    "gaClid": "345345353.234234234",
    "roistatClid": "323423423",
    "calltouchClid": "234234234",
    "comagicClid": "34223234",
    "city": "Москва",
    "region": "Москва",
    "country": "Россия",
    "ipAddress": "127.0.0.1",
    "pagesCount": 5,
    "entryPoint": "https://callkeeper.ru/blog",
    "entryPointQuery": "https://callkeeper.ru/call-tracking/",
    "counts": 12,
    "userAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko)",
    "device": "iphone 7",
    "cbWidgetHash": "xxx99xx99xxxxx999xxxxxx9999xxx99",
    "cbToolId": 1000,
    "cbCallId": 10000000,
    "cbUid": 1000,
    "cbToolName": "Виджет обратного звонка",
    "cbOfficeNumber": "0",
    "cbOfficeName": "Moscow office",
    "cbOrderDate":  "2020-05-04 12:13:22",
    "cbAttempt": 3,
    "cbAttemptsQueue": [
      10000000,
      11111111
    ],
    "cbConnectType": "smartcall",
    "cbSmartCallCount": 5,
    "cbIvrCount": 12,
    "cbEventSource":  "api",
    "ctCallId": 100000,
    "ctCampaignId": 1000,
    "ctCampaignName": "sale",
    "ctIsListened": "1",
    "tags": [
      "some tag",
      "any tag"
    ],  
    "hooks": [
      {  
          "hookEventName": "AFTER_CALL_FINISH",
          "hookAddress": "https://server.ru/path",
          "hookMethod": "POST",
          "hookResponseStatus": 200
      }  
    ]
  }
]  
```
#### Описание полей  
Значения возвращаемые данным методом описаны в следующем порядке:  

*имя параметра* - описание параметра (тип данных)  

Если параметр может принимать одно из нескольких значений то они будут перечислены через запятую. Ни один из параметров не принимает значение NULL. В случае если параметр пустой то вместо NULL у строковых значений будет пустая строка, у числовых значений 0, у массивов - пустой массив. В ответе есть параметры специфичные как для сервиса Callback, они обозначаются префиксом "cb" перед названием параметра. Также есть параметры специфичные для сервиса CallTracking, они обозначены префиксом "ct". Параметры без этих префиксов являются общими для обоих сервисов.

*page* - номер текущей страницы (INT)  
*universalId* – универсальный id звонка в callback и calltracking (STRING)  
*serviceType* – текстовое название сервиса ("callback","calltracking","import")  
*clientNumber* – номер телефона клиента (STRING)  
*managerNumber* – реальный (не подстановочный) номер дилерского центра (STRING)  
*callerIdToManager* – номер который подставится в сторону менеджера (STRING)   
*callerIdToClient* – номер который подставится в сторону клиента (STRING)  
*statusFirst* – статус звонка оператору (для callback) или на подстановочный номер (для calltracking) (INT)  
*statusSecond* - статус звонка клиенту (для callback) или на номер переадресации (для calltracking) (INT)  
*status* - статус звонка, успешный или не успешный ("success", "fail")  
*callTime* – дата и время звонка (DATE)  
*localDate* - дата и время в часовом поясе клиента (DATE)  
*timezoneOffset* - смещение часового пояса (STRING)  
*duration* – время разговора в секундах (INT)  
*tariffTime* - таррифицируемое время разговора в минутах (INT)  
*site* – сайт из настроек виджета или из кампании (STRING)  
*recordUrl* – ссылка на запись разговора (STRING)  
*unique* – уникальный ли звонок (BOOL)  
*target* – целевой ли звонок (BOOL)  
*uniqueTarget* – уникально-целевой ли звонок (BOOL)  
*siteVisit* – сайт на который был визит с последующим звонком (STRING)  
*referrer* – сайт с которого был переход (STRING)  
*utm_source* – рекламная метка utm_source (STRING)  
*utm_medium* – рекламная метка utm_medium (STRING)  
*utm_campaign* – рекламная метка utm_campaign (STRING)  
*utm_content* – рекламная метка utm_content (STRING)  
*utm_term* - рекламная метка utm_term (STRING)  
*yaClid* – идентификатор клиента в сервисе Яндекс.Метрика (STRING)  
*gaClid* –  идентификатор клиента в сервисе Google analytics (STRING)  
*roistatClid* – идентификатор клиента в сервисе Roistat (STRING)  
*comagicClid* – идентификатор клиента в сервисе Comagic (STRING)  
*calltouchClid* – идентификатор клиента в сервисе Calltouch (STRING)  
*city* – город нахождения посетителя (STRING)
*region* – регион нахождения посетителя (STRING)  
*country* – cтрана нахождения посетителя (STRING)
*ipAddress*  - ip адрес посетителя (STRING)  
*pagesCount* – количество страниц на которые зашел пользователь за визит (INT)  
*entryPoint* – страница входа на сайт (STRING)  
*entryPointQuery* – страница входа вместе с гет параметрами (STRING)  
*callPage* – страница с которой был совершен или заказан звонок (STRING)  
*counts* – всего количество визитов этого пользователя на сайт (INT)  
*userAgent* – user agent строка идентифицирующая браузер посетителя (STRING)  
*device* – тип устройства (STRING)  
*cbWidgetHash* – уникальный хэш виджета (STRING)  
*cbToolId* – id виджета (INT)  
*cbCallId* – id звонка (INT)  
*cbUid* - id аккаунта (INT)  
*cbToolName* – название инструмента с которого был заказан звонок (INT)  
*cbOfficeNumber* – порядковый номер офиса (INT)  
*cbOfficeName* – название офиса (STRING)  
*cbOrderDate** – дата заказа звонка (DATE)  
*cbAttempt* – номер попытки дозвона (INT)  
*cbAttemptsQueue* – id звонков предыдущих попыток дозвона (ARRAY[INT])  
*cbConnectType* – тип соединения ("auto","smartcall","dtmf")  
*cbSmartCallCount* – количество попыток распознавания smartcall или dtmf (INT)  
*cbIvrCount* – сколько раз проговорился ivr (INT)  
*cbEventSource* – c какого инструмента заказан звонок ("widget","mobile","api","lg","iform","form","ckapp","hand","fb","vk","ok")  
*ctCallId* – ID звонка в коллтреккинге (INT)  
*ctCampaignId* – ID кампании в коллтреккинге (INT)  
*ctCampaignName* – название кампании (STRING)  
*ctIsListened* – прослушана ли запись ("","0","1")  
*tags* – массив тэгов присвоенных звонку (ARRAY[STRING])  
*hooks* – хуки которые были отправлены по звонку (ARRAY[OBJECT])  
*hookEventName* – событие по которому был отправлен звонок ("AFTER_CALL_FINISH","BEFORE_CALL_START")  
*hookAddress* – адрес на который отправлен хук (STRING)  
*hookMethod* – http метод которым был отправлен хук ("GET","POST","PUT","DELETE")  
*hookResponseStatus* – http ответ принимающего сервера (INT)  
#### Форматы ответов при неправильном или неуспешном запросе  
В случае если по каким либо причнам запрос был неуспешный, то ответ вернется следующего формата:
```
{
  "inbound": {
    "error": "No rows found"
  },
  "info": {
    "entities": {
      "call": ["get"],
      "callrole": ["get"],
      "phone": ["get"],
      "user": ["get"],
      "campaign": ["get"],
      "tag": ["get"]
    },
    "types": ["json", "plain", "csv", "xml"],
    "versions": ["v1"]
  },
  "payload": []
}
```
В данном ответе поле "info" носит информационный характер, и во всех неуспешных запросах оно будет одинаковое. Поле "payload" также во всех запросах закончившихся неудачей будет одинаковое, пустое, что означает что данных в ответе нет.  

Значимым для обработки неуспешного ответа является лишь поле "inbound". В случае невалидного запроса оно будет содержать ключ "error", в котором будет находится текстовое описание ошибки.
#### Описание возможных ошибок при запросах к API
1. Не найдено звонков за выбранный период, или звонков у данного пользователя нет в принципе.
```
"error": "No rows found"
```
2. Параметр [***{{format}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный
```
"error":"Type to return is not available"
```
3. Параметр [***{{version}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный
```
"error":"It is wrong API version"
```
4. Параметр [***{{apikey}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный
```
"error":"User is not recognized"
```
5. Параметр [***{{entity}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный
```
"error":"Entity does not exist"
```
6. Параметр [***{{method}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный
```
"error":"Method does not exist"
```
7. Параметр [***{{pages}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный либо он превышает количество страниц в ответе
```
"error":"Incorrect page is set"
```
8. Параметр [***{{from}}***](#описание-параметров-запроса) в запросе отсутствует либо неверный либо он превышает количество страниц в ответе
```
"error":"Start date has wrong type. Possible format is 'Y-m-d' or timestamp"
```


